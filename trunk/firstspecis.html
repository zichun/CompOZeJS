<html>
<head>
<script src="lib/abcjs_editor_1.0.12-min.js" type="text/javascript"></script>
<script src="lib/Note.js" type="text/javascript"></script>
<script src="lib/Interval.js" type="text/javascript"></script>
<script type="text/javascript">
function firstSpecies() {
	/*var soln = [
		new Note('A',0),
		new Note('A',0),
		new Note('G',0),
		new Note('A',0),
		new Note('B',0),
		new Note('C',1),
		new Note('C',1),
		new Note('B',0),
		new Note('D',1),
		new Note('C#',1),
		new Note('D',1)
	];*/
	var dorian = [
		new Note('D',0),
		new Note('F',0),
		new Note('E',0),
		new Note('D',0),
		new Note('G',0),
		new Note('F',0),
		new Note('A',0),
		new Note('G',0),
		new Note('F',0),
		new Note('E',0),
		new Note('D',0)
	];
	var dorian = [
		new Note('D',0),
		new Note('E',0),
		new Note('F',0),
		new Note('E',0),
		new Note('G',0),
		new Note('F',0),
		new Note('A',0),
		new Note('G',0),
		new Note('F',0),
		new Note('E',0),
		new Note('D',0)
	];
//	var composition = [soln, dorian];
//	alert(checkConstraints(composition));
//		return false;
	var composition = [[], dorian];
	var result = runDFS(0, composition);

	var abc = document.getElementById('abc');
	abc.value = '';
	for (var i=0;i<composition[0].length;++i) {
		abc.value += composition[0][i].toABC() + '8|';
	}
	
}
function runDFS(i, composition) {
	if (checkConstraints(composition) === false) return false;
	if (i === composition[1].length) {
		// we got a solution
		return true;
	}
	
	for (var notes in Note.NotesToSemiTones) {
		if (Note.NotesToSemiTones.hasOwnProperty(notes) === false) continue;
		if (notes.length === 2 && i !== composition[1].length-2) continue;
		
		for (var j=0;j<=1;++j) {
			composition[0][i] = new Note(notes,j);
			if (runDFS(i+1, composition)) return true;
		}
	}
	return false;
}
function checkConstraints(composition) {
	for (var i=0;i<constraints.length;++i) {
		if (constraints[i](composition) === false) {
			return false;
		}
	}
	return true;
}

var constraints = [
	function noDissonance(composition) {
		for (var i=0;i<composition[0].length;++i) {
			var interval = composition[0][i].interval( composition[1][i] );
			var n = interval.getInterval();
			if (n !== 0 && n !== 5 && n !== 3 && n !== 6 && n !== 8) return false;
			if (interval.getType() === Interval.AUGMENTED || interval.getType() === Interval.DIMINISHED) return false;
			if (n === 5 && interval.getType() !== Interval.PERFECT) return false;
		}
		return true;
	},
	
	function noDirectToPerfectConsonance(composition) {
		for (var i=0;i<composition[0].length-1;++i) {
			var s0 = composition[0][i+1].getAbsoluteSemitone() - composition[0][i].getAbsoluteSemitone();
			var s1 = composition[1][i+1].getAbsoluteSemitone() - composition[1][i].getAbsoluteSemitone();
			
			if (s0 * s1 > 0) { // direct motion
				var interval = composition[0][i+1].interval( composition[1][i+1] );
				var n = interval.getInterval();
				if (n != 3 && n != 6) return false;
			}
		}
		return true;
	},
	
	function noAugmentedOrDiminishedNoteBetweenSuceedingNotes(composition) {
		for (var i=0;i<composition[0].length-1;++i) {
			var interval = composition[0][i+1].interval( composition[1][i] );
			if (interval.getType === Interval.AUGMENTED || interval.getType === Interval.DIMINISHED) return false;
		}
		return true;
	},
	
	function noMajorSixOrSevenOrOctaveLeap(composition) {
		for (var i=0;i<composition[0].length-1;++i) {
			var interval = composition[0][i].interval( composition[0][i+1] );
			var n = interval.getInterval();
			if (interval.getType() === Interval.MAJOR && (n === 6 || n === 7)) return false;
			if (composition[0][i+1].getAbsoluteSemitone() - composition[0][i].getAbsoluteSemitone() > 12) return false; // larger than an octave
		}
		return true;
	},
	function noCrossing(composition) {
		if (composition[0].length === 0) return true;
		
		var above = composition[0][0].getAbsoluteSemitone() > composition[1][0].getAbsoluteSemitone();
		for (var i=1;i<composition[0].length;++i) {
			var sabove = composition[0][i].getAbsoluteSemitone() > composition[1][i].getAbsoluteSemitone();
			if (above !== sabove) return false;
		}
		return true;
	},
	function noUnison(composition) {
		// Unisons are not allowed, except in the first bar.
		for (var i=1;i<composition[0].length;++i) {
			if (composition[0][i].getAbsoluteSemitone() === composition[1][i].getAbsoluteSemitone()) return false;
		}
		return true;
	},
	function firstBarIsOctaveFifthOrUnison(composition) {
		if (composition[0].length > 0) {
			var interval = composition[0][0].interval( composition[1][0] );
			var n = interval.getInterval();
			if (n != 0 && n != 5 && n != 8) return false;
		}
		return true;
	},
	function secondLastBarMajorSixth(composition) {
		if (composition[0].length >= composition[1].length-1) {
			var lb = composition[1].length-2;
			var interval = composition[0][lb].interval( composition[1][lb] );
			var n = interval.getInterval();
			if (n === 6 && interval.getType() === Interval.MAJOR) return true;
			return false;
		}
		return true;
	},
	function lastBarOctave(composition) {
		if (composition[0].length >= composition[1].length) {
			var lb = composition[1].length-1;
			var interval = composition[0][lb].interval( composition[1][lb] );
			var n = interval.getInterval();
			if (n === 8) return true;
			return false;
		}
		return true;
	}
];

//var a = new Note('D',0);
//var b = new Note('Db',0);
//alert(a.interval(b).getInterval());
//firstSpecies = false;
</script>
</head>

<body onload="firstSpecies();">
<textarea id="abc" cols="80" rows="15">X: 1
X: 1 
M: C|
V: RH1 clef=treble name="Piano" 
V: LH1 clef=treble
K: C
% 
[V: RH1] D8|F8|E8|D8|G8|F8|A8|G8|F8|E8|D8||
[V: LH1] D8|F8|E8|D8|G8|F8|A8|G8|F8|E8|D8||</textarea>


</body>
</html>